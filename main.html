<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kangaRoooMer â€” Copycat Trading</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a222c;
      --panel: #232d3a;
      --border: #3d4f5c;
      --text: #e8edf2;
      --muted: #7a8a99;
      --accent: #2dd4bf;
      --accent-dim: #14b8a6;
      --amber: #f59e0b;
      --green: #22c55e;
      --red: #ef4444;
      --radius: 10px;
      --font-sans: "Outfit", system-ui, sans-serif;
      --font-mono: "IBM Plex Mono", monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      background-image:
        radial-gradient(ellipse 80% 40% at 50% -10%, rgba(45, 212, 191, 0.08), transparent 50%),
        radial-gradient(ellipse 60% 30% at 100% 50%, rgba(245, 158, 11, 0.05), transparent 45%);
    }
    .app {
      max-width: 720px;
      margin: 0 auto;
      padding: 1.5rem;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .logo-emoji { font-size: 1.6rem; }
    .logo-text {
      font-weight: 700;
      font-size: 1.35rem;
      background: linear-gradient(135deg, var(--accent), var(--amber));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .tagline { font-size: 0.75rem; color: var(--muted); margin-top: 0.1rem; }
    .wallet-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .addr {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--muted);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .btn {
      font-family: var(--font-sans);
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    .btn:hover { background: var(--surface); border-color: var(--accent); }
    .btn-primary {
      background: linear-gradient(135deg, #0d9488, #14b8a6);
      border-color: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { box-shadow: 0 0 18px rgba(45, 212, 191, 0.35); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--accent);
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .stat {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem;
      text-align: center;
    }
    .stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-value { font-family: var(--font-mono); font-size: 1rem; margin-top: 0.25rem; }
    input[type="text"], input[type="number"] {
      width: 100%;
      font-family: var(--font-mono);
      font-size: 0.9rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    input::placeholder { color: var(--muted); }
    label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.25rem; }
    .form-row { margin-bottom: 0.75rem; }
    .msg { font-size: 0.85rem; padding: 0.5rem; border-radius: var(--radius); margin-top: 0.5rem; }
    .msg.err { background: rgba(239, 68, 68, 0.15); color: var(--red); }
    .msg.ok { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .tab {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      cursor: pointer;
      font-weight: 500;
    }
    .tab.active { background: var(--panel); color: var(--accent); border-color: var(--accent); }
    .tab:hover:not(.active) { color: var(--text); }
    .tab-content { display: none; }
    .tab-content.visible { display: block; }
    .list-compact { font-family: var(--font-mono); font-size: 0.8rem; color: var(--muted); }
    .list-compact div { padding: 0.35rem 0; border-bottom: 1px solid var(--border); }
    .list-compact div:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <span class="logo-emoji">ðŸ¦˜</span>
        <div>
          <div class="logo-text">kangaRoooMer</div>
          <div class="tagline">Copycat trading â€” mirror leaders, hop with the pack</div>
        </div>
      </div>
      <div class="wallet-row">
        <span id="wallet-addr" class="addr">â€”</span>
        <button id="btn-connect" class="btn">Connect</button>
      </div>
    </header>

    <div class="card">
      <h2>Contract</h2>
      <div class="form-row">
        <label>Kanga contract address</label>
        <input type="text" id="contract-address" placeholder="0xâ€¦" />
      </div>
      <button id="btn-set-contract" class="btn btn-primary">Set contract</button>
      <div id="contract-msg"></div>
    </div>

    <div class="card">
      <h2>Stats</h2>
      <div class="stats-row">
        <div class="stat"><div class="stat-label">Trails</div><div id="stat-trails" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Leaders</div><div id="stat-leaders" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Sessions</div><div id="stat-sessions" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Replicas</div><div id="stat-replicas" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Halted</div><div id="stat-halted" class="stat-value">â€”</div></div>
      </div>
    </div>

    <div class="card">
      <h2>Actions</h2>
      <div class="tabs">
        <button class="tab active" data-tab="enroll">Enroll mirror</button>
        <button class="tab" data-tab="trail">Execute trail</button>
        <button class="tab" data-tab="replica">Open / Close replica</button>
        <button class="tab" data-tab="leader">Designate leader</button>
        <button class="tab" data-tab="quote">Quote</button>
      </div>

      <div id="panel-enroll" class="tab-content visible">
        <div class="form-row"><label>Leader address</label><input type="text" id="enroll-leader" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Max allocation (wei or ether string)</label><input type="text" id="enroll-alloc" placeholder="1000000000000000000" /></div>
        <div class="form-row"><label>Trail slippage (bps, e.g. 100)</label><input type="text" id="enroll-slippage" placeholder="100" /></div>
        <button id="btn-enroll" class="btn btn-primary">Enroll as mirror</button>
      </div>

      <div id="panel-trail" class="tab-content">
        <div class="form-row"><label>Follower address</label><input type="text" id="trail-follower" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Token in</label><input type="text" id="trail-tokenIn" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Token out</label><input type="text" id="trail-tokenOut" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Amount in (raw units)</label><input type="text" id="trail-amountIn" placeholder="1000000000000000000" /></div>
        <div class="form-row"><label>Amount out min (raw units)</label><input type="text" id="trail-amountOutMin" placeholder="0" /></div>
        <div class="form-row"><label>Deadline (unix timestamp)</label><input type="text" id="trail-deadline" placeholder="9999999999" /></div>
        <button id="btn-trail" class="btn btn-primary">Execute trail</button>
      </div>

      <div id="panel-replica" class="tab-content">
        <p style="font-size:0.85rem; color: var(--muted); margin-bottom: 0.75rem;">Open replica: leader sends tokens; follower gets position. Close: follower closes by ID.</p>
        <div class="form-row"><label>Open â€” Follower address</label><input type="text" id="replica-follower" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Open â€” Token in</label><input type="text" id="replica-tokenIn" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Open â€” Token out</label><input type="text" id="replica-tokenOut" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Open â€” Amount in</label><input type="text" id="replica-amountIn" placeholder="1000000000000000000" /></div>
        <button id="btn-open-replica" class="btn btn-primary">Open replica</button>
        <hr style="border-color: var(--border); margin: 1rem 0;" />
        <div class="form-row"><label>Close â€” Replica ID</label><input type="text" id="replica-close-id" placeholder="1" /></div>
        <div class="form-row"><label>Close â€” Amount out min</label><input type="text" id="replica-amountOutMin" placeholder="0" /></div>
        <div class="form-row"><label>Close â€” Deadline</label><input type="text" id="replica-deadline" placeholder="9999999999" /></div>
        <button id="btn-close-replica" class="btn btn-primary">Close replica</button>
      </div>

      <div id="panel-leader" class="tab-content">
        <div class="form-row"><label>Leader address</label><input type="text" id="leader-addr" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Max followers cap</label><input type="text" id="leader-cap" placeholder="200" /></div>
        <button id="btn-designate-leader" class="btn btn-primary">Designate leader</button>
      </div>

      <div id="panel-quote" class="tab-content">
        <div class="form-row"><label>Token in</label><input type="text" id="quote-tokenIn" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Token out</label><input type="text" id="quote-tokenOut" placeholder="0xâ€¦" /></div>
        <div class="form-row"><label>Amount in</label><input type="text" id="quote-amountIn" placeholder="1000000000000000000" /></div>
        <button id="btn-quote" class="btn btn-primary">Get quote</button>
        <div id="quote-result" class="list-compact" style="margin-top:0.75rem;"></div>
      </div>

      <div id="action-msg" class="msg" style="margin-top:0.75rem;"></div>
    </div>

    <div class="card">
      <h2>My sessions (read)</h2>
      <button id="btn-load-sessions" class="btn">Load my session IDs</button>
      <div id="sessions-list" class="list-compact" style="margin-top:0.5rem;"></div>
    </div>
  </div>

  <script>
    (function() {
      const KANGA_ABI = [
        "function enrollMirror(address leader, uint256 maxAllocWei, uint256 trailSlippageBps) external returns (uint256 sessionId)",
        "function executeTrail(address follower, address tokenIn, address tokenOut, uint256 amountIn, uint256 amountOutMin, uint256 deadline) external returns (uint256 amountOut, uint256 trailId)",
        "function openReplica(address follower, address tokenIn, address tokenOut, uint256 amountIn) external returns (uint256 replicaId)",
        "function closeReplica(uint256 replicaId, uint256 amountOutMin, uint256 deadline) external returns (uint256 amountOut, uint256 feeWei)",
        "function designateLeader(address leader, uint256 maxFollowersCap) external",
        "function getQuoteOut(address tokenIn, address tokenOut, uint256 amountIn) external view returns (uint256[] memory amounts)",
        "function getSessionIdsForFollower(address follower) external view returns (uint256[] memory)",
        "function getMirrorSession(uint256 sessionId) external view returns (address follower, address leader, uint256 maxAllocWei, uint256 usedAllocWei, uint256 trailSlippageBps, uint256 openedAtBlock, bool active)",
        "function trailCounter() external view returns (uint256)",
        "function leaderCounter() external view returns (uint256)",
        "function sessionCounter() external view returns (uint256)",
        "function replicaCounter() external view returns (uint256)",
        "function botHalted() external view returns (bool)",
        "event MirrorEnrolled(address indexed follower, address indexed leader, uint256 maxAllocWei, uint256 trailSlippageBps, uint256 sessionId, uint256 atBlock)",
        "event TrailExecuted(address indexed leader, address indexed follower, address tokenIn, address tokenOut, uint256 amountIn, uint256 amountOut, uint256 trailId, uint256 atBlock)"
      ];

      let provider, signer, contractAddress = "", contract = null;

      const walletEl = document.getElementById("wallet-addr");
      const btnConnect = document.getElementById("btn-connect");
      const contractInput = document.getElementById("contract-address");
      const btnSetContract = document.getElementById("btn-set-contract");
      const contractMsg = document.getElementById("contract-msg");
      const actionMsg = document.getElementById("action-msg");
      const statTrails = document.getElementById("stat-trails");
      const statLeaders = document.getElementById("stat-leaders");
      const statSessions = document.getElementById("stat-sessions");
      const statReplicas = document.getElementById("stat-replicas");
      const statHalted = document.getElementById("stat-halted");

      function showMsg(container, text, type) {
        container.innerHTML = text ? `<div class="msg ${type}">${text}</div>` : "";
      }

      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("visible"));
          tab.classList.add("active");
          const id = "panel-" + tab.dataset.tab;
          const panel = document.getElementById(id);
          if (panel) panel.classList.add("visible");
        });
      });

      btnSetContract.addEventListener("click", () => {
        const addr = (contractInput.value || "").trim();
        if (!addr || !addr.startsWith("0x")) {
          showMsg(contractMsg, "Enter a valid contract address (0xâ€¦).", "err");
          return;
        }
        contractAddress = addr;
        contract = new ethers.Contract(addr, KANGA_ABI, signer || provider);
        showMsg(contractMsg, "Contract set.", "ok");
        refreshStats();
      });

      async function connect() {
        if (typeof window.ethereum === "undefined") {
          showMsg(contractMsg, "Install MetaMask or another Web3 wallet.", "err");
          return;
        }
        try {
          provider = new ethers.BrowserProvider(window.ethereum);
          const accounts = await provider.send("eth_requestAccounts", []);
          if (!accounts.length) return;
          signer = await provider.getSigner();
          const addr = await signer.getAddress();
          walletEl.textContent = addr.slice(0, 6) + "â€¦" + addr.slice(-4);
          btnConnect.textContent = "Connected";
          btnConnect.disabled = true;
          if (contractAddress) {
            contract = new ethers.Contract(contractAddress, KANGA_ABI, signer);
            refreshStats();
          }
        } catch (e) {
          showMsg(contractMsg, e.message || "Connection failed.", "err");
        }
      }
      btnConnect.addEventListener("click", connect);

      async function refreshStats() {
        if (!contract || !provider) return;
        try {
          const [trails, leaders, sessions, replicas, halted] = await Promise.all([
            contract.trailCounter(),
            contract.leaderCounter(),
            contract.sessionCounter(),
            contract.replicaCounter(),
            contract.botHalted()
          ]);
          statTrails.textContent = trails.toString();
          statLeaders.textContent = leaders.toString();
          statSessions.textContent = sessions.toString();
          statReplicas.textContent = replicas.toString();
          statHalted.textContent = halted ? "Yes" : "No";
        } catch (_) {
          statTrails.textContent = statLeaders.textContent = statSessions.textContent = statReplicas.textContent = statHalted.textContent = "â€”";
        }
      }

      document.getElementById("btn-enroll").addEventListener("click", async () => {
        if (!contract || !signer) { showMsg(actionMsg, "Connect wallet and set contract.", "err"); return; }
        const leader = (document.getElementById("enroll-leader").value || "").trim();
        let maxAlloc = (document.getElementById("enroll-alloc").value || "").trim();
        const slippage = (document.getElementById("enroll-slippage").value || "100").trim();
        if (!leader || !leader.startsWith("0x")) { showMsg(actionMsg, "Invalid leader address.", "err"); return; }
        try {
          if (maxAlloc.includes(".")) maxAlloc = ethers.parseEther(maxAlloc).toString();
          else if (!maxAlloc) maxAlloc = "1000000000000000000";
        } catch (_) { }
        const slippageBps = parseInt(slippage, 10) || 100;
        showMsg(actionMsg, "Confirm in walletâ€¦", "ok");
        try {
          const tx = await contract.enrollMirror(leader, BigInt(maxAlloc), slippageBps);
          await tx.wait();
          showMsg(actionMsg, "Enrolled. Tx: " + tx.hash.slice(0, 12) + "â€¦", "ok");
          refreshStats();
        } catch (e) {
          showMsg(actionMsg, e.message || "Tx failed.", "err");
        }
      });

      document.getElementById("btn-trail").addEventListener("click", async () => {
        if (!contract || !signer) { showMsg(actionMsg, "Connect wallet and set contract.", "err"); return; }
        const follower = (document.getElementById("trail-follower").value || "").trim();
        const tokenIn = (document.getElementById("trail-tokenIn").value || "").trim();
        const tokenOut = (document.getElementById("trail-tokenOut").value || "").trim();
        const amountIn = (document.getElementById("trail-amountIn").value || "0").trim();
        const amountOutMin = (document.getElementById("trail-amountOutMin").value || "0").trim();
        const deadline = (document.getElementById("trail-deadline").value || "9999999999").trim();
        if (!follower.startsWith("0x") || !tokenIn.startsWith("0x") || !tokenOut.startsWith("0x") || !amountIn || amountIn === "0") {
          showMsg(actionMsg, "Fill valid addresses and non-zero amount.", "err");
          return;
        }
        showMsg(actionMsg, "Confirm in walletâ€¦", "ok");
        try {
          const tx = await contract.executeTrail(follower, tokenIn, tokenOut, BigInt(amountIn), BigInt(amountOutMin), BigInt(deadline));
          await tx.wait();
          showMsg(actionMsg, "Trail executed. Tx: " + tx.hash.slice(0, 12) + "â€¦", "ok");
          refreshStats();
        } catch (e) {
          showMsg(actionMsg, e.message || "Tx failed.", "err");
        }
      });

      document.getElementById("btn-open-replica").addEventListener("click", async () => {
        if (!contract || !signer) { showMsg(actionMsg, "Connect wallet and set contract.", "err"); return; }
        const follower = (document.getElementById("replica-follower").value || "").trim();
        const tokenIn = (document.getElementById("replica-tokenIn").value || "").trim();
        const tokenOut = (document.getElementById("replica-tokenOut").value || "").trim();
        const amountIn = (document.getElementById("replica-amountIn").value || "0").trim();
        if (!follower.startsWith("0x") || !tokenIn.startsWith("0x") || !tokenOut.startsWith("0x")) {
          showMsg(actionMsg, "Fill valid addresses and amount.", "err");
